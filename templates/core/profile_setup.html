{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% translate "Completar Perfil" %} - ForgeLock{% endblock %}

{% block extra_css %}
<style>
    .form-control[readonly] {
        background-color: #f8f9fa;
        color: #6c757d;
        cursor: not-allowed;
    }
    .form-control[disabled] {
        background-color: #f8f9fa;
        color: #6c757d;
        cursor: not-allowed;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            <div class="form-container">
                <h2 class="text-center mb-4">
                    <i class="fas fa-user-edit me-2"></i>{% translate "Completar Perfil" %}
                </h2>
                
                <div class="alert alert-info mb-4">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>{% translate "Bem-vindo ao ForgeLock!" %}</strong>
                    <br>
                    <small>{% translate "Vamos completar seu perfil para uma melhor experiência." %}</small>
                </div>
                
                <form method="post" novalidate>
                    {% csrf_token %}
                    
                    <!-- Nome e Sobrenome lado a lado -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.first_name.id_for_label }}" class="form-label">{% translate "Nome" %}</label>
                                {{ form.first_name }}
                                {% if form.first_name.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.first_name.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.last_name.id_for_label }}" class="form-label">{% translate "Sobrenome" %}</label>
                                {{ form.last_name }}
                                {% if form.last_name.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.last_name.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Usuário -->
                    <div class="mb-3">
                        <label for="{{ form.username.id_for_label }}" class="form-label">{% translate "Usuário" %}</label>
                        {{ form.username }}
                        {% if form.username.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.username.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- Email -->
                    <div class="mb-3">
                        <label for="{{ form.email.id_for_label }}" class="form-label">{% translate "E-mail" %}</label>
                        {{ form.email }}
                        {% if form.email.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.email.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- País (somente exibição) -->
                    <div class="mb-3">
                        <label class="form-label">{% translate "País" %}</label>
                        <input type="text" class="form-control" value="{{ user.country.name }}" readonly>
                    </div>
                    
                    <!-- DDI e Telefone lado a lado -->
                    <div class="row">
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label class="form-label">{% translate "DDI" %}</label>
                                <input type="text" class="form-control" value="{{ user.country.ddi }}" readonly>
                            </div>
                        </div>
                        <div class="col-md-9">
                            <div class="mb-3">
                                <label for="{{ form.phone_number.id_for_label }}" class="form-label">{% translate "Telefone" %}</label>
                                {{ form.phone_number }}
                                {% if form.phone_number.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.phone_number.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Data de Nascimento -->
                    <div class="mb-3">
                        <label for="{{ form.birth_date.id_for_label }}" class="form-label">{% translate "Data de nascimento" %}</label>
                        {{ form.birth_date }}
                        {% if form.birth_date.help_text %}
                            <div class="form-text">{{ form.birth_date.help_text }}</div>
                        {% endif %}
                        {% if form.birth_date.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.birth_date.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- Endereço -->
                    <div class="mb-4">
                        <h5 class="mb-3">
                            <i class="fas fa-map-marker-alt me-2"></i>{% translate "Endereço" %}
                        </h5>
                        
                        <!-- CEP e Número lado a lado -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.zip_code.id_for_label }}" class="form-label">
                                        {{ form.zip_code.label }}
                                    </label>
                                    {{ form.zip_code }}
                                    {% if form.zip_code.help_text %}
                                        <div class="form-text">{{ form.zip_code.help_text }}</div>
                                    {% endif %}
                                    {% if form.zip_code.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.zip_code.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.address_number.id_for_label }}" class="form-label">
                                        {{ form.address_number.label }}
                                    </label>
                                    {{ form.address_number }}
                                    {% if form.address_number.help_text %}
                                        <div class="form-text">{{ form.address_number.help_text }}</div>
                                    {% endif %}
                                    {% if form.address_number.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.address_number.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Endereço -->
                        <div class="mb-3">
                            <label for="{{ form.address.id_for_label }}" class="form-label">
                                {{ form.address.label }}
                            </label>
                            {{ form.address }}
                            {% if form.address.help_text %}
                                <div class="form-text">{{ form.address.help_text }}</div>
                            {% endif %}
                            {% if form.address.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.address.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <!-- Cidade e Estado lado a lado -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.city.id_for_label }}" class="form-label">
                                        {{ form.city.label }}
                                    </label>
                                    {{ form.city }}
                                    {% if form.city.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.city.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.state.id_for_label }}" class="form-label">
                                        {{ form.state.label }}
                                    </label>
                                    {{ form.state }}
                                    {% if form.state.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.state.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Website -->
                    <div class="mb-3">
                        <label for="{{ form.website.id_for_label }}" class="form-label">{% translate "Site pessoal" %}</label>
                        {{ form.website }}
                        {% if form.website.help_text %}
                            <div class="form-text">{{ form.website.help_text }}</div>
                        {% endif %}
                        {% if form.website.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.website.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                     <div class="d-flex justify-content-between align-items-center mt-4">
                         <!-- Botão Voltar -->
                         <a href="{% url 'dashboard' %}" class="btn {% if is_first_access %}btn-outline-secondary disabled{% else %}btn-gradient-outline{% endif %}" {% if is_first_access %}onclick="return false;"{% endif %}>
                             <i class="fas fa-arrow-left"></i>{% translate "Voltar" %}
                         </a>
                         
                         <!-- Botão Editar/Salvar centralizado -->
                         <button type="button" class="btn btn-gradient-outline" id="edit-save-btn">
                             <i class="fas fa-edit"></i>{% translate "Editar" %}
                         </button>
                         
                         <!-- Botão Avançar -->
                         <button type="submit" name="action" value="avancar" class="btn {% if not is_first_access %}btn-outline-secondary disabled{% else %}btn-gradient-outline{% endif %}" {% if not is_first_access %}onclick="return false;"{% endif %}>
                             <i class="fas fa-arrow-right"></i>{% translate "Avançar" %}
                         </button>
                     </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const editSaveBtn = document.getElementById('edit-save-btn');
    const form = document.querySelector('form');
    const editableFields = ['date_of_birth', 'website'];
    let isEditing = false;
    
    // Função para habilitar/desabilitar campos editáveis
    function toggleEditMode(editing) {
        isEditing = editing;
        editableFields.forEach(fieldName => {
            const field = document.getElementById('id_' + fieldName);
            if (field) {
                if (editing) {
                    field.removeAttribute('readonly');
                    field.removeAttribute('disabled');
                } else {
                    field.setAttribute('readonly', 'readonly');
                    // Não desabilitar para que o valor seja enviado
                }
            }
        });
        
        // Atualizar botão
        if (editSaveBtn) {
                                if (editing) {
                        editSaveBtn.innerHTML = '<i class="fas fa-save"></i>{% translate "Salvar" %}';
                        editSaveBtn.className = 'btn btn-gradient-enabled';
                        editSaveBtn.type = 'submit';
                    } else {
                        editSaveBtn.innerHTML = '<i class="fas fa-edit"></i>{% translate "Editar" %}';
                        editSaveBtn.className = 'btn btn-gradient-outline';
                        editSaveBtn.type = 'button';
                    }
        }
    }
    
    // Inicializar em modo de visualização
    toggleEditMode(false);
    
    // Botão Editar/Salvar
    if (editSaveBtn) {
        editSaveBtn.addEventListener('click', function(e) {
            if (!isEditing) {
                // Modo editar
                e.preventDefault();
                toggleEditMode(true);
            }
            // Se estiver editando, o botão é type="submit" e envia o formulário
        });
    }
    
    // Quando o formulário é enviado com sucesso, voltar ao modo de visualização
    {% if messages %}
        toggleEditMode(false);
    {% endif %}
    
    // Se há mensagens de sucesso, voltar ao modo de visualização
    {% if messages %}
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(function() {
                toggleEditMode(false);
            }, 2000);
        });
    {% endif %}
    
    // Inicializar automação de endereço
    initAddressAutocomplete({
        postalCodeField: '#{{ form.zip_code.id_for_label }}',
        addressField: '#{{ form.address.id_for_label }}',
        cityField: '#{{ form.city.id_for_label }}',
        stateField: '#{{ form.state.id_for_label }}',
        numberField: '#{{ form.address_number.id_for_label }}'
    });
});
</script>

<!-- Script de automação de endereço -->
<script src="{% static 'js/address-autocomplete.js' %}"></script>
{% endblock %} 